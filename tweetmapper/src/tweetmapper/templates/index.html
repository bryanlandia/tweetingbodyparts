<!DOCTYPE html>
<meta charset="utf-8">
<style>

path {
	fill: transparent;
	stroke: #aaa;
}
</style>
<body>
<h1>Americans tweeting about their bits</h1>

<link rel="stylesheet" type="text/css" href="/static/css/style.css" />
<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
<script src="http://d3js.org/topojson.v1.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
<script>

(function() {

		var width = 1100,
	    height = 600,
	    projection;


		var svg = d3.select("body").append("svg")
	    .attr("width", width)
	    .attr("height", height);

		d3.json("/static/data/us.json", function(error, us) {
		  if (error) return console.error(error);
		  console.log(us);

		  var land = topojson.feature(us, us.objects.land);
		  projection = d3.geo.albersUsa()
		  	.scale(1100)
		  	.translate([width/2, height/2]);

		  var path = d3.geo.path()
	    	.projection(projection);

		  svg.append("path")
	      	.datum(land)
	      	.attr("d", path);

	     update_points();

		});     

		function add_points(points, text) {
			// add point if it doesn't already exist
			debugger;
			var join = svg.selectAll('circle.bpart').data(points);
			join.enter()
			    .append("circle")
			    .attr("cx", function(d) {
			      return projection(d)[0];
			    })
			    .attr("cy", function(d) {
			      return projection(d)[1];
			    })
			    .attr("class", "bpart")
			    .attr("r", "8px");
			join.exit().remove(); // delete if not present in data
		}

		function update_points() {
		    $.ajax({
            type: "GET",
            contentType: "application/json; charset=utf-8",
            url: '/data',
            dataType: 'json',
            async: true,
            cache: false,
            success: function (data) {
            	// write new points to map				
            	// debugger
            	if (data){
            		var points = new Array();
                    for (var loc in data) {
                    	if (data.hasOwnProperty(loc)) {
	                    	point = loc.split(",");
	                    	points.push(point);
					   	}
				    }
				    add_points(points);					    
               }
            },
            error: function(xhr, textStatus, errorThrown){
               console.log(textStatus + ', ' + errorThrown);
          	}
	    	})
		}

		var intv_id = setInterval(update_points, 5 * 1000);

	})(jQuery);


</script>
</body>
</html>